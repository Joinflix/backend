<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JoinFlex | 결제 및 환불 테스트</title>
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 50px 20px; }
        h1 { margin-bottom: 30px; color: #1a1a1a; }

        /* 멤버십 카드 섹션 */
        .membership-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 1000px; margin-bottom: 50px; }
        .card { background: white; border-radius: 16px; padding: 30px; width: 230px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 2px solid transparent; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: #3182f6; }
        .plan-name { font-size: 18px; font-weight: bold; color: #555; }
        .price { font-size: 26px; font-weight: 800; color: #3182f6; margin: 15px 0; }
        .desc { font-size: 13px; color: #888; margin-bottom: 20px; line-height: 1.4; }

        button { background: #3182f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; }
        button:hover { background: #1b64da; }

        /* 결제 내역 섹션 */
        .history-section { background: white; padding: 30px; width: 100%; max-width: 900px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; padding-bottom: 15px; border-bottom: 2px solid #f0f2f5; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 14px; text-align: center; border-bottom: 1px solid #eee; }
        th { font-size: 14px; color: #666; background: #fafafa; }

        /* 상태별 배지 */
        .status-badge { font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold; }
        .status-COMPLETED, .status-PAID { background: #e6f7ff; color: #1890ff; } /* PAID 상태도 파란색으로 처리 */
        .status-REFUND, .status-REFUNDED { background: #fff1f0; color: #f5222d; }

        .btn-refund { background: #ff4d4f; font-size: 12px; width: auto; padding: 6px 12px; }
        .btn-refund:disabled { background: #d9d9d9; cursor: not-allowed; }
    </style>
</head>
<body>

<h1>멤버십 요금제 선택</h1>

<div class="membership-container">
    <div class="card">
        <div class="plan-name">광고형 스탠다드</div>
        <div class="price">100원</div>
        <div class="desc">합리적인 가격으로<br>JoinFlex를 시작하세요.</div>
        <button onclick="requestPay(2, 100, '광고형 스탠다드')">선택하기</button>
    </div>

    <div class="card">
        <div class="plan-name">스탠다드</div>
        <div class="price">200원</div>
        <div class="desc">가장 인기 있는 플랜!<br>무광고로 즐기세요.</div>
        <button onclick="requestPay(3, 200, '스탠다드')">선택하기</button>
    </div>

    <div class="card">
        <div class="plan-name">프리미엄</div>
        <div class="price">300원</div>
        <div class="desc">최고의 화질과 음향<br>4대 동시 접속 가능</div>
        <button onclick="requestPay(4, 300, '프리미엄')">선택하기</button>
    </div>
</div>

<div class="history-section">
    <h2>나의 결제 및 환불 내역</h2>
    <table>
        <thead>
        <tr>
            <th>주문ID</th>
            <th>멤버십</th>
            <th>금액</th>
            <th>결제일시</th>
            <th>상태</th>
            <th>작업</th>
        </tr>
        </thead>
        <tbody id="payment-history-body">
        <tr><td colspan="6">결제 내역을 불러오고 있습니다...</td></tr>
        </tbody>
    </table>
</div>

<script>
    if (window.IMP) window.IMP.init("imp10502566");

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    document.addEventListener('DOMContentLoaded', fetchHistory);

    function requestPay(membershipId, amount, planName) {
        if (!token) return alert("로그인 토큰이 없습니다.");

        window.IMP.request_pay({
            pg: "html5_inicis",
            pay_method: "card",
            merchant_uid: "ORD-" + membershipId + "-" + Date.now(),
            name: "JoinFlex " + planName,
            amount: amount,
            buyer_email: "test@test.com"
        }, function (rsp) {
            if (rsp.success) {
                sendToServer(rsp, membershipId);
            } else {
                alert("결제 실패: " + rsp.error_msg);
            }
        });
    }

    function sendToServer(rsp, membershipId) {
        fetch("/api/payments/complete", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify({
                imp_uid: rsp.imp_uid,
                merchant_uid: rsp.merchant_uid,
                paid_amount: rsp.paid_amount,
                membershipId: membershipId,
                pay_method: rsp.pay_method,
                status: 'paid'
            })
        })
            .then(res => res.json())
            .then(() => {
                alert("결제 완료!");
                fetchHistory();
            })
            .catch(err => console.error("결제 처리 에러:", err));
    }

    function fetchHistory() {
        if(!token) return;

        fetch("/api/payments/me", {
            headers: { "Authorization": "Bearer " + token }
        })
            .then(res => res.json())
            .then(data => {
                const body = document.getElementById('payment-history-body');
                body.innerHTML = '';

                if (data.length === 0) {
                    body.innerHTML = '<tr><td colspan="6">결제 내역이 없습니다.</td></tr>';
                    return;
                }

                data.forEach(p => {
                    const isRefunded = (p.status === 'REF_REQUESTED' || p.status === 'REFUND' || p.status === 'REFUNDED');

                    // 날짜 포맷팅 (YYYY-MM-DD HH:mm)
                    const date = new Date(p.paidAt);
                    const formattedDate = date.getFullYear() + '-' +
                        String(date.getMonth() + 1).padStart(2, '0') + '-' +
                        String(date.getDate()).padStart(2, '0') + ' ' +
                        String(date.getHours()).padStart(2, '0') + ':' +
                        String(date.getMinutes()).padStart(2, '0');

                    body.innerHTML += `
                <tr>
                    <td><strong>${p.paymentId}</strong></td>
                    <td>${p.membershipName}</td>
                    <td>${p.amount.toLocaleString()}원</td>
                    <td style="font-size: 13px; color: #666;">${formattedDate}</td>
                    <td><span class="status-badge status-${p.status}">${p.status}</span></td>
                    <td>
                        <button class="btn-refund" onclick="requestRefund(${p.paymentId})" ${isRefunded ? 'disabled' : ''}>
                            ${isRefunded ? '환불처리완료' : '환불요청'}
                        </button>
                    </td>
                </tr>
            `;
                });
            });
    }

    function requestRefund(paymentId) {
        if (!confirm("해당 결제 건을 환불하시겠습니까? (7일 이내 미사용 시 가능)")) return;

        fetch("/api/refunds", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify({
                paymentId: paymentId,
                reason: "사용자 테스트 환불"
            })
        })
            .then(async res => {
                const result = await res.json();
                if (res.ok) {
                    alert("환불이 성공적으로 처리되었습니다.");
                    fetchHistory();
                } else {
                    alert("환불 실패: " + (result.message || "조건을 확인해주세요."));
                }
            })
            .catch(err => alert("서버 통신 오류가 발생했습니다."));
    }
</script>
</body>
</html>